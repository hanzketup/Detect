version: 2
jobs:
  build_backend:
    working_directory: ~/project/backend
    docker:
      - image: circleci/node:7.10
      - image: mongo:latest
    steps:
      - checkout:
          path: ~/project
      - restore_cache:
          key: dependency-cache-{{ checksum "package.json" }}
      - run: npm install
      - run: npm run build
      - save_cache:
          key: dependency-cache-{{ checksum "package.json" }}
          paths:
            - ~/project/backend/node_modules

  test_backend:
    working_directory: ~/project/backend
    docker:
      - image: circleci/node:7.10
      - image: mongo:latest
    steps:
      - checkout:
          path: ~/project
      - run: |
             sudo apt-get update &&
             sudo apt-get install -yq --no-install-recommends
             gconf-service
            libasound2
            libatk1.0-0
            libc6
            libcairo2
            libcups2
            libdbus-1-3
            libexpat1
            libfontconfig1
            libgcc1
            libgconf-2-4
            libgdk-pixbuf2.0-0
            libglib2.0-0
            libgtk-3-0
            libnspr4
            libpango-1.0-0
            libpangocairo-1.0-0
            libstdc++6
            libx11-6
            libx11-xcb1
            libxcb1
            libxcomposite1
            libxcursor1
            libxdamage1
            libxext6
            libxfixes3
            libxi6
            libxrandr2
            libxrender1
            libxss1
            libxtst6
            ca-certificates
            fonts-liberation
            libappindicator1
            libnss3
            lsb-release
            xdg-utils
            wget
      - restore_cache:
          key: dependency-cache-{{ checksum "package.json" }}
      - run: npm run test

  build_frontend:
    working_directory: ~/project/frontend
    docker:
      - image: circleci/node:7.10
    steps:
      - checkout:
          path: ~/project
      - run: npm install

workflows:
  version: 2
  build_and_test:
    jobs:
      - build_backend
      - test_backend:
          requires:
            - build_backend
      - build_frontend
